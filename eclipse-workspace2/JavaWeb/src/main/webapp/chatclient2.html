<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Chat Client</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css">
        <link rel="stylesheet" href="/JavaWeb/css/buttons.css">
    </head>
    <body style="padding: 20px">
        <h1>我的聊天室</h1>
        <div class="pure-form">
            <fieldset>
                <legend>聊天室</legend>
                <button type="button" id="onOpenButton" class="button-success pure-button">連線</button>
                <button type="button" id="onCloseButton" class="button-error pure-button">離線</button>
                <p></p>
                <input type="text" id="messageInput" placeholder="請輸入訊息" />
                <button type="button" id="onMessageButton" class="button-secondary pure-button">傳送</button>
            </fieldset>
        </div>
        <div class="pure-form">
            <fieldset>聊天歷史紀錄</fieldset>
            <div id="messageHistory"></div>
        </div>
    </body>
	<script type="text/javascript">
	function startup() {
	    addStatusDisplay();
	    const connectionStatus = document.getElementById('connectionStatus');

		    
		    const onOpenButton = document.getElementById('onOpenButton');
		    const onCloseButton = document.getElementById('onCloseButton');
		    const messageInput = document.getElementById('messageInput');
		    const onMessageButton = document.getElementById('onMessageButton');
		    const messageHistory = document.getElementById('messageHistory');

	    onOpenButton.disabled = false;
	    onCloseButton.disabled = true;
	    messageInput.disabled = true;
	    onMessageButton.disabled = true;

	    let webSocket = null;
	    let reconnectTimer = null;
	    
	    const wsurl = 'ws://localhost:8080/JavaWeb/chatserver';

	    // 显示连接状态
	    function setStatus(status) {
	        connectionStatus.textContent = status;
	    }

	    function setWebSocket() {
	        setStatus('正在连接...');
	        webSocket = new WebSocket(wsurl);

	        webSocket.onopen = function () {
	            setStatus('已连接');
	            onOpenButton.disabled = true;
	            onCloseButton.disabled = false;
	            messageInput.disabled = false;
	            onMessageButton.disabled = false;
	            if (reconnectTimer) {
	                clearInterval(reconnectTimer);
	                reconnectTimer = null;
	            }
	        };

	        webSocket.onmessage = function (event) {
	            const message = event.data;
	            // 使用更美观的消息格式
	            const messageElement = document.createElement('div');
	            messageElement.classList.add('chat-message');
	            messageElement.textContent = message;
	            // 最新消息插入顶部
	            messageHistory.insertBefore(messageElement, messageHistory.firstChild);
	        };

	        webSocket.onclose = function () {
	            setStatus('已断开连接，正在尝试重连...');
	            onOpenButton.disabled = false;
	            onCloseButton.disabled = true;
	            messageInput.disabled = true;
	            onMessageButton.disabled = true;
	            attemptReconnect();
	        };

	        webSocket.onerror = function (e) {
	            console.error('WebSocket错误:', e);
	            alert('WebSocket连接发生错误！');
	        };
	    }

	    // 自动重连机制：每隔5秒尝试连接一次
	    function attemptReconnect() {
	        if (reconnectTimer) return; // 已有重连计时，避免重复

	        reconnectTimer = setInterval(() => {
	            console.log('尝试重连...');
	            setStatus('尝试重连...');
	            setWebSocket();
	        }, 5000);
	    }

	    // 点击连接按钮
	    onOpenButton.addEventListener('click', function () {
	        setWebSocket();
	    });

	    // 点击断开按钮
	    onCloseButton.addEventListener('click', function () {
	        if (webSocket) {
	            setStatus('主动断开连接');
	            webSocket.close();
	            if (reconnectTimer) {
	                clearInterval(reconnectTimer);
	                reconnectTimer = null;
	            }
	        }
	    });

	    // 点击发送按钮
	    onMessageButton.addEventListener('click', function () {
	        sendMessage();
	    });

	    // 支持回车键发送消息
	    messageInput.addEventListener('keydown', function (event) {
	        if (event.key === 'Enter') {
	            event.preventDefault(); // 防止换行
	            sendMessage();
	        }
	    });

	    // 发送消息函数
	    function sendMessage() {
	        if (!webSocket || webSocket.readyState !== WebSocket.OPEN) {
	            alert('尚未连接到服务器，无法发送消息');
	            return;
	        }
	        const msg = messageInput.value.trim();
	        if (msg.length === 0) return;

	        webSocket.send(msg);

	        // 发送后清空输入框，并重新聚焦
	        messageInput.value = '';
	        messageInput.focus();
	    }

	    // 页面上动态添加连接状态显示区域
	    function addStatusDisplay() {
	        let statusDiv = document.getElementById('connectionStatus');
	        if (!statusDiv) {
	            statusDiv = document.createElement('div');
	            statusDiv.id = 'connectionStatus';
	            statusDiv.style.margin = '10px 0';
	            statusDiv.style.fontWeight = 'bold';
	            statusDiv.style.color = '#555';
	            // 将状态插入到按钮区域下方
	            const pureFormDiv = document.querySelector('.pure-form');
	            pureFormDiv.parentNode.insertBefore(statusDiv, pureFormDiv.nextSibling);
	        }
	        setStatus('未连接');
	    }

	    addStatusDisplay();
	}
	window.onload = startup;
	</script>
	
</html>

